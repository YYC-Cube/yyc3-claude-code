# Ralph-Loop-文档闭环工具需求规格说明书（立项版）

1 引言
1.1 文档目的
本文档明确文档闭环工具的功能需求、非功能需求、接口规范及验收标准，作为项目立项、开发、测试、验收的核心依据，确保各方对工具建设目标、范围及质量要求达成一致。
1.2 项目背景
当前业务场景中，文档从创建、流转、审核、修订至归档全流程存在断点，存在版本混乱、审批追溯难、责任未明确、闭环状态不可视等问题，导致工作效率低下、合规风险提升。为解决上述痛点，实现文档全生命周期闭环管理，特立项开发本工具。
1.3 范围界定
本次项目覆盖文档闭环核心流程，包括文档创建与版本管理、流转审批、任务追踪、归档沉淀四大模块；适配企业内部办公场景，支持PC端访问，暂不覆盖移动端功能。
2 功能需求及功能清单
2.1 核心功能模块
2.1.1 文档管理模块
• 文档创建：支持在线编辑（富文本、Markdown格式）、本地文件上传（Word、Excel、PDF、PPT等常见格式），自动生成唯一文档编号。
• 版本控制：每次修改自动生成新版本，记录版本号、修改人、修改时间、修改内容摘要，支持版本回溯、版本对比（可视化差异展示）。
• 文档分类：支持自定义分类目录，可按部门、业务类型、文档状态标签归类，支持模糊搜索、按属性筛选（创建人、时间、状态等）。
2.1.2 闭环流程管理模块
• 流程配置：支持可视化拖拽配置审批流程，可设置审批节点、审批人（单人、多人会签、多人或签）、超时提醒（自定义超时时间、提醒方式）。
• 流转发起：文档创建后可发起流转，系统自动推送至首个审批节点，支持附带流转说明、关联业务单据。
• 审批操作：审批人可执行通过、驳回（需填写驳回理由）、转批（指定其他审批人）操作，支持在线批注文档内容。
• 状态追踪：实时展示文档流转节点、当前处理人、处理进度，支持发起方、审批人查看全流程轨迹。
2.1.3 任务追踪模块
• 任务生成：审批过程中可针对文档内容创建待办任务，指定负责人、完成时限、任务描述，关联对应文档版本。
• 任务提醒：通过系统消息、邮件双重提醒负责人，超时未完成自动升级提醒（推送至负责人上级）。
• 任务闭环：负责人完成任务后上传成果物，发起方确认后任务闭环，全程记录任务状态变更日志。
2.1.4 归档与权限管理模块
• 文档归档：流程结束（审批通过/终止）后自动归档，支持手动归档、批量归档，归档后文档不可修改（仅可查看、导出）。
• 权限控制：基于角色分配权限（管理员、创建人、审批人、查看者），细粒度控制文档操作权限（编辑、删除、发起流转、批注、导出），支持权限批量分配、单个文档权限微调。
• 日志审计：记录所有文档操作（创建、修改、审批、权限变更、导出）日志，包含操作人、时间、操作内容，日志不可删除，支持按条件查询导出。
2.2 功能清单汇总
模块名称
功能点名称
优先级（高/中/低）
备注

文档管理
在线创建与文件上传
高
支持主流文档格式

版本控制与回溯对比
高
保留所有修改轨迹

分类与搜索筛选
中
支持多维度筛选

闭环流程管理
可视化流程配置
高
无需代码开发

流转发起与节点推送
高
自动推送至对应审批人

审批操作与在线批注
高
批注内容关联版本

流转状态实时追踪
高
全流程轨迹可视化

任务追踪
待办任务创建与分配
中
关联对应文档

多渠道提醒与超时升级
高
系统消息+邮件提醒

任务闭环与成果确认
高
记录成果物与确认日志

归档与权限管理
自动/手动归档
高
归档后不可修改

角色化权限分配
高
细粒度权限控制

操作日志审计
中
日志不可删除，支持导出

3 非功能需求
3.1 性能需求
• 响应速度：页面加载时间≤2秒，文档打开、版本对比、搜索查询响应时间≤1.5秒，审批操作提交响应时间≤1秒。
• 并发能力：支持同时在线用户≥500人，同时发起流转/审批操作≥50次/分钟，文档上传（单文件最大500MB）无卡顿。
• 稳定性：系统连续运行无故障时间≥99.9%，月度故障总时长≤43分钟，故障恢复时间≤10分钟。
3.2 安全性需求
• 数据安全：文档数据传输采用HTTPS加密，存储采用AES-256加密，敏感操作（删除、权限变更）需二次确认，定期数据备份（每日全量备份+实时增量备份，备份数据保留90天）。
• 访问安全：支持账号密码+验证码登录，连续5次密码错误锁定账号（1小时后自动解锁），支持单点登录（SSO）集成，会话超时时间可配置（默认30分钟无操作超时退出）。
• 合规性：日志审计满足企业内控要求，可追溯所有操作行为，支持对接企业隐私保护合规体系。
3.3 易用性需求
• 界面设计：遵循企业现有UI规范，操作路径简洁，核心功能（发起流转、审批、追踪）入口明确，支持新手引导弹窗。
• 操作门槛：无需专业培训即可上手基础操作，复杂功能（流程配置）提供可视化指引，支持在线帮助文档查询。
3.4 可扩展性需求
• 架构扩展：采用微服务架构，支持后续新增模块（如移动端适配、批量处理功能）无侵入式集成。
• 接口扩展：预留开放接口，支持与企业OA、CRM、知识库等系统后续对接，可自定义新增字段、扩展流程节点类型。
4 接口规范
4.1 接口类型及通用规范
所有接口采用RESTful风格，请求/响应格式为JSON，编码格式UTF-8，接口调用需携带Token身份认证（Token有效期2小时，过期自动刷新）。
4.2 核心内部接口
接口名称
接口地址
请求方式
核心请求参数
响应参数（核心）

文档创建接口
/api/document/create
POST
title（文档标题）、content（内容）、file（文件流，可选）、categoryId（分类ID）、creatorId（创建人ID）
docId（文档ID）、docNo（文档编号）、createTime（创建时间）、status（初始状态）

流程发起接口
/api/flow/start
POST
docId（文档ID）、flowId（流程ID）、description（流转说明）、relatedNo（关联单据号，可选）
flowNo（流转编号）、currentNodeId（当前节点ID）、currentHandlerId（当前处理人ID）

任务创建接口
/api/task/create
POST
docId（文档ID）、version（版本号）、handlerId（负责人ID）、deadline（截止时间）、taskDesc（任务描述）
taskId（任务ID）、taskStatus（初始状态）、remindTime（提醒时间）

4.3 外部对接接口（预留）
• SSO登录接口：/api/sso/login，支持对接企业统一身份认证系统，获取用户信息（用户名、部门、角色）。
• OA消息推送接口：/api/notify/oa，将审批提醒、任务提醒推送至企业OA系统。
4.4 接口安全规范
接口调用需校验签名（请求参数+密钥生成签名，服务器端反向验证），禁止跨域请求（配置白名单），异常请求（频繁调用、参数非法）自动限流（10分钟内同一IP异常请求≥20次，限制调用30分钟）。
5 验收标准
5.1 功能验收标准（按模块）
5.1.1 文档管理模块
• 文档创建：可成功在线编辑富文本/Markdown内容，支持上传主流格式文件（测试覆盖Word、PDF、Excel），文档编号自动生成且唯一，无重复。
• 版本控制：修改文档后自动生成新版本，版本日志记录完整，版本回溯可恢复至历史版本，版本对比可清晰展示修改差异（文字增删、格式调整）。
• 分类搜索：可自定义分类目录，文档归类准确，模糊搜索、多属性筛选可快速定位目标文档（搜索结果≤1.5秒返回，准确率100%）。
5.1.2 闭环流程管理模块
• 流程配置：可通过拖拽配置3个以上节点的流程，支持会签、或签设置，超时提醒时间可自定义，配置后生效无延迟。
• 流转与审批：发起流转后，审批人可及时收到推送，通过、驳回、转批操作正常生效，批注内容可保存并关联对应版本，流转轨迹完整可查。
5.1.3 任务追踪与归档权限模块
• 任务追踪：创建任务后负责人收到双重提醒，超时未完成自动升级提醒，任务完成后发起方确认即可闭环，日志记录完整。
• 归档权限：流程结束后自动归档，归档后文档不可修改，权限分配准确（不同角色仅拥有对应操作权限，无越权操作），操作日志可查询、导出。
5.2 非功能验收标准
• 性能：页面加载、接口响应、搜索查询均满足对应时间要求，500人并发在线、50次/分钟流转操作无卡顿，连续运行72小时无故障。
• 安全：数据传输加密、存储加密验证通过，敏感操作二次确认生效，备份数据可正常恢复，账号锁定、超时退出功能正常。
• 易用性：新手引导弹窗正常展示，核心功能操作路径≤3步，无专业培训的普通用户可独立完成基础操作（文档创建、发起流转、审批）。
5.3 接口验收标准
• 所有核心接口调用成功率100%，响应时间≤1秒，参数校验严格（非法参数返回明确错误提示，无系统崩溃）。
• 接口签名验证、限流功能生效，跨域请求被拦截，白名单内IP可正常调用外部接口。
5.4 验收方式
采用测试用例全覆盖验收（每个功能点对应至少1条测试用例），结合实际业务场景模拟操作（模拟3个部门的真实文档流转场景），测试通过后由产品、开发、测试、业务方四方签字确认。
6 备注
本说明书可根据立项评审意见、业务需求变更进行修订，修订后需同步更新版本号并归档，确保各环节使用最新版本文档。
7 分阶段实施项目计划（Project适配版）
本项目总周期优化为16周（2026年3月1日-2026年6月21日），调整各阶段任务分工与时间衔接，强化并行效率，以下为Project适配的可视化甘特图核心数据（可直接导入Microsoft Project生成图表），同步更新文档内对应内容确保一致性。
7.1 调整说明（周期与任务分配优化点）
• 周期优化：将原开发阶段部分串行任务调整为并行，压缩冗余时间；测试验收阶段新增1天缓冲期，应对突发问题；上线运维阶段提前1天完成培训，预留上线后缓冲。
• 任务分配：细化开发分工（前端/后端明确拆分并行任务），新增“测试工程师”专项负责集成测试与UAT统筹，运维工程师提前介入环境搭建，提升协作效率。
• 依赖优化：明确各任务前置关系（标注前置任务ID），避免逻辑冲突，适配Project自动计算任务时序功能。
7.2 Project适配任务清单（可直接导入）
任务ID
任务名称（层级）
阶段
开始时间
结束时间
工期
负责人（资源）
前置任务
交付物
1
一、需求细化与设计阶段
需求设计
2026-03-01
2026-03-28
4周
产品经理、架构师
•
设计阶段全套交付物
2
需求评审与细化
需求设计
2026-03-01
2026-03-14
2周
产品经理
1
修订版需求规格说明书、用户故事清单
3
UI/UE设计
需求设计
2026-03-08
2026-03-21
2周（与任务2并行1周）
UI设计师
2（第1周末里程碑）
界面原型稿、交互流程图
4
架构与数据库设计
需求设计
2026-03-08
2026-03-21
2周（与任务2并行1周）
架构师
2（第1周末里程碑）
数据库设计文档、架构设计文档
5
设计评审与技术栈确认
需求设计
2026-03-22
2026-03-25
4天
产品经理、架构师
3,4
设计评审报告、技术栈确认单、开发规范文档
6
项目启动会与环境搭建
需求设计
2026-03-26
2026-03-28
3天
项目经理、运维工程师
5
启动会议纪要、开发/测试环境搭建确认单
7
二、开发实现阶段
开发实现
2026-03-31
2026-05-09
6周
前后端开发、全栈开发
6
开发阶段全套交付物
8
文档管理模块开发（后端）
开发实现
2026-03-31
2026-04-12
2周
后端开发工程师
7
文档管理后端代码、单元测试报告
9
基础权限控制开发（后端）
开发实现
2026-03-31
2026-04-12
2周（与任务8并行）
后端开发工程师
7
权限控制后端代码、单元测试报告
10
文档管理+权限模块前端开发
开发实现
2026-04-07
2026-04-19
2周（与任务8、9并行1周）
前端开发工程师
8（第1周末里程碑）
前端页面代码、交互效果演示包
11
流程管理模块开发（后端）
开发实现
2026-04-15
2026-04-26
2周
后端开发工程师
8,9
流程管理后端代码、接口开发文档
12
流程管理模块前端开发
开发实现
2026-04-22
2026-05-03
2周（与任务11并行1周）
前端开发工程师
11（第1周末里程碑）
流程管理前端代码、可视化流程配置演示包
13
任务追踪+归档模块开发
开发实现
2026-04-29
2026-05-06
1周
全栈开发工程师
11,12
任务追踪/归档模块代码、单元测试报告
14
接口联调与系统集成测试
开发实现
2026-05-07
2026-05-09
3天
全栈开发、测试工程师
10,13
接口联调报告、集成测试报告、Bug修复清单
15
阶段性交付与反馈收集
开发实现
2026-05-09
2026-05-09
1天
项目经理、产品经理
14
功能演示报告、业务方反馈清单
16
三、测试验收阶段
测试验收
2026-05-12
2026-06-06
4周
测试工程师、产品经理
15
测试验收全套交付物
17
全面测试（功能/性能/安全/易用性）
测试验收
2026-05-12
2026-05-23
2周
测试工程师、开发工程师
16
全面测试报告、Bug闭环清单、优化后版本
18
UAT测试（业务方实操）
测试验收
2026-05-26
2026-05-30
1周
测试工程师、产品经理、业务方
17
UAT测试报告、验收问题清单
19
验收问题整改与最终确认
测试验收
2026-06-02
2026-06-06
1周（含1天缓冲）
项目经理、各方负责人
18
验收确认单、最终版系统部署包
20
四、上线运维阶段
上线运维
2026-06-09
2026-06-21
2周
运维工程师、产品经理
19
上线运维全套交付物
21
生产环境部署与数据初始化
上线运维
2026-06-09
2026-06-12
4天
运维工程师
20
部署报告、数据初始化确认单
22
用户培训（操作手册+实操）
上线运维
2026-06-13
2026-06-14
2天
产品经理、培训师
21
操作手册、培训纪要、培训签到表
23
系统正式上线与运维支持
上线运维
2026-06-17
2026-06-21
1周（含2天缓冲）
运维工程师、开发工程师
22
上线总结报告、运维日志、反馈处理清单
二、开发实现阶段
开发实现
2026-03-31
2026-05-09
6周
前后端开发、全栈开发
6
开发阶段全套交付物
8
文档管理模块开发（后端）
开发实现
2026-03-31
2026-04-12
2周
后端开发工程师
7
文档管理后端代码、单元测试报告
9
基础权限控制开发（后端）
开发实现
2026-03-31
2026-04-12
2周（与任务8并行）
后端开发工程师
7
权限控制后端代码、单元测试报告
10
文档管理+权限模块前端开发
开发实现
2026-04-07
2026-04-19
2周（与任务8、9并行1周）
前端开发工程师
8（第1周末里程碑）
前端页面代码、交互效果演示包
11
流程管理模块开发（后端）
开发实现
2026-04-15
2026-04-26
2周
后端开发工程师
8,9
流程管理后端代码、接口开发文档
12
流程管理模块前端开发
开发实现
2026-04-22
2026-05-03
2周（与任务11并行1周）
前端开发工程师
11（第1周末里程碑）
流程管理前端代码、可视化流程配置演示包
13
任务追踪+归档模块开发
开发实现
2026-04-29
2026-05-06
1周
全栈开发工程师
11,12
任务追踪/归档模块代码、单元测试报告
14
接口联调与系统集成测试
开发实现
2026-05-07
2026-05-09
3天
全栈开发、测试工程师
10,13
接口联调报告、集成测试报告、Bug修复清单
15
阶段性交付与反馈收集
开发实现
2026-05-09
2026-05-09
1天
项目经理、产品经理
14
功能演示报告、业务方反馈清单
16
三、测试验收阶段
测试验收
2026-05-12
2026-06-06
4周
测试工程师、产品经理
15
测试验收全套交付物
17
全面测试（功能/性能/安全/易用性）
测试验收
2026-05-12
2026-05-23
2周
测试工程师、开发工程师
16
全面测试报告、Bug闭环清单、优化后版本
18
UAT测试（业务方实操）
测试验收
2026-05-26
2026-05-30
1周
测试工程师、产品经理、业务方
17
UAT测试报告、验收问题清单
19
验收问题整改与最终确认
测试验收
2026-06-02
2026-06-06
1周（含1天缓冲）
项目经理、各方负责人
18
验收确认单、最终版系统部署包
20
四、上线运维阶段
上线运维
2026-06-09
2026-06-21
2周
运维工程师、产品经理
19
上线运维全套交付物
21
生产环境部署与数据初始化
上线运维
2026-06-09
2026-06-12
4天
运维工程师
20
部署报告、数据初始化确认单
22
用户培训（操作手册+实操）
上线运维
2026-06-13
2026-06-14
2天
产品经理、培训师
21
操作手册、培训纪要、培训签到表
23
系统正式上线与运维支持
上线运维
2026-06-17
2026-06-21
1周（含2天缓冲）
运维工程师、开发工程师
22
上线总结报告、运维日志、反馈处理清单
7.3 Project导入指引与Excel模板
1. 复制上述表格内容，粘贴至Excel中，按“任务ID、任务名称、开始时间、结束时间、工期、负责人、前置任务”列整理（删除多余列）；2.  打开Microsoft Project，通过“数据→从文件导入”选择Excel文件，映射对应字段；3.  系统自动生成甘特图，可手动调整视图样式（添加资源分配、依赖关系可视化）；4.  工期单位已适配Project（周/天），前置任务按ID关联，无需额外修改逻辑。
7.3.1 可直接导入的Excel模板（含数据验证规则+格式化表头）
以下模板已预设格式化表头（居中对齐、字体加粗、固定列宽）及数据验证规则，可直接复制至Excel生成标准模板，也可按下方指引生成可下载.xlsx文件，确保数据格式符合Project导入要求，避免格式错乱。
任务ID
任务名称（层级）
开始时间
结束时间
工期
负责人（资源）
前置任务
交付物
1
一、需求细化与设计阶段
2026-03-01
2026-03-28
4周
产品经理、架构师
•
设计阶段全套交付物
2
需求评审与细化
2026-03-01
2026-03-14
2周
产品经理
1
修订版需求规格说明书、用户故事清单
数据验证规则配置说明（已预设逻辑，可直接套用）
为避免输入格式错误导致Project导入失败，模板已配置以下验证规则，可在Excel中通过“数据→数据验证”功能查看/调整：
2. 任务ID列（A列）：仅允许输入正整数，且值唯一（防止重复ID导致依赖关系错乱），输入非整数时提示“请输入唯一正整数ID”。
3. 开始时间/结束时间列（C、D列）：仅允许输入日期格式（YYYY-MM-DD），且日期范围限定在项目总周期内（2026-03-01至2026-06-21），同时结束时间≥开始时间，不符合时提示“请输入项目周期内有效日期，且结束时间不早于开始时间”。
4. 工期列（E列）：仅允许输入“X周”“X天”格式文本（X为正整数，如“2周”“3天”），禁止纯数字或其他格式，提示语为“请按格式输入工期（例：2周、3天）”。
5. 前置任务列（G列）：允许输入正整数、逗号（多任务依赖分隔）或“-”（无前置任务），禁止其他字符，提示语为“请输入任务ID（多ID用逗号分隔）或‘-’”。
6. 负责人/任务名称/交付物列（B、F、H列）：仅允许输入文本，禁止空值（核心字段必填），提示语为“请输入有效文本，不可为空”。
可直接下载的.xlsx文件生成指引
7. 新建Excel工作簿，复制上述表格（含表头及示例行）粘贴至Sheet1，Excel将自动继承表头格式及列宽；
8. 按上述数据验证规则，在对应列配置数据验证（可直接复制下方规则代码导入Excel，无需手动设置）；
9. 删除示例行（第2-3行），保留表头，将7.2节任务清单内容逐行粘贴至模板，保存为“.xlsx”格式即可直接下载使用；
10. 若需快速获取配置好的模板，可将此文档中的模板内容复制至在线Excel工具（如石墨、腾讯文档），完成验证规则配置后导出为.xlsx文件，全程无需复杂操作。
7.3.3 完整.bas格式宏代码文件（可直接导出使用）
以下为完整的.bas格式宏代码，可直接复制保存为“.bas”文件，再导入Excel宏编辑器，无需手动调整代码格式，适配Excel 2016及以上版本（Excel 365最优）。
' ===========================================================================
' 文档闭环工具项目计划Excel模板 - 数据验证规则宏代码
' 版本：V1.0
' 功能：自动为Project导入模板配置全列数据验证规则，避免格式错误
' 适用范围：模板A-H列（任务ID至交付物）
' 依赖：Excel 365（REGEXMATCH函数支持），低版本需替换正则逻辑
' ===========================================================================
Option Explicit
Sub SetDataValidation()
' 关闭屏幕更新，提升执行速度
Application.ScreenUpdating = False
' -------------------------- 任务ID列（A列）：唯一正整数 --------------------------
With Columns("A:A").Validation
.Delete ' 清除原有验证规则
.Add Type:=xlValidateWholeNumber, _
AlertStyle:=xlValidAlertStop, _
Operator:=xlBetween, _
Formula1:="1", _
Formula2:="100" ' 限制ID范围1-100，可按需调整
.IgnoreBlank = False ' 禁止空值
.InCellDropdown = True
.InputTitle = "任务ID验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入唯一正整数ID（1-100）"
.ErrorMessage = "请输入1-100之间的唯一正整数，不可重复或非整数"
.ShowInput = True ' 显示输入提示
.ShowError = True ' 显示错误提示
End With
' 补充ID唯一性验证（触发式）
Call SetIDUniqueValidation
' -------------------------- 开始时间列（C列）：项目周期内日期 --------------------------
With Columns("C:C").Validation
.Delete
.Add Type:=xlValidateDate, _
AlertStyle:=xlValidAlertStop, _
Operator:=xlBetween, _
Formula1:="2026-03-01", _
Formula2:="2026-06-21" ' 限定项目总周期
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "开始时间验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入2026-03-01至2026-06-21之间的日期（YYYY-MM-DD）"
.ErrorMessage = "日期超出项目周期，或格式错误（需为YYYY-MM-DD）"
.ShowInput = True
.ShowError = True
End With
' -------------------------- 结束时间列（D列）：不早于开始时间 --------------------------
With Columns("D:D").Validation
.Delete
.Add Type:=xlValidateCustom, _
AlertStyle:=xlValidAlertStop, _
Formula1:="=AND(D1>=C1,D1>=DATE(2026,3,1),D1<=DATE(2026,6,21))" ' 双重校验
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "结束时间验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入不早于开始时间、且在项目周期内的日期"
.ErrorMessage = "结束时间需≥开始时间，且在2026-03-01至2026-06-21之间"
.ShowInput = True
.ShowError = True
End With
' -------------------------- 工期列（E列）：X周/X天格式 --------------------------
With Columns("E:E").Validation
.Delete
.Add Type:=xlValidateCustom, _
AlertStyle:=xlValidAlertStop, _
Formula1:="=OR(REGEXMATCH(E1,""^\d+周$""),REGEXMATCH(E1,""^\d+天$""))" ' 正则校验格式
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "工期格式验证"
.ErrorTitle = "输入错误"
.InputMessage = "请按格式输入（例：2周、3天，仅正整数+单位）"
.ErrorMessage = "格式错误！仅支持「X周」或「X天」格式（X为正整数）"
.ShowInput = True
.ShowError = True
End With
' -------------------------- 前置任务列（G列）：ID/逗号/-格式 --------------------------
With Columns("G:G").Validation
.Delete
.Add Type:=xlValidateCustom, _
AlertStyle:=xlValidAlertStop, _
Formula1:="=OR(G1=""-"",REGEXMATCH(G1,""^(\d+,)*\d+$""))" ' 支持单ID、多ID、无前置
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "前置任务验证"
.ErrorTitle = "输入错误"
.InputMessage = "无前置填「-」；多任务依赖用逗号分隔（例：1,3）"
.ErrorMessage = "格式错误！仅允许正整数、逗号或「-」"
.ShowInput = True
.ShowError = True
End With
' -------------------------- 文本列（B、F、H列）：非空文本 --------------------------
Call SetTextColumnValidation(Columns("B:B"), "任务名称") ' 任务名称列
Call SetTextColumnValidation(Columns("F:F"), "负责人")   ' 负责人列
Call SetTextColumnValidation(Columns("H:H"), "交付物")   ' 交付物列
' 恢复屏幕更新，提示完成
Application.ScreenUpdating = True
MsgBox "数据验证规则配置完成！已覆盖所有核心列，可直接录入数据。", vbInformation, "配置成功"
End Sub
' 子过程：任务ID唯一性验证（工作表变更触发）
Private Sub SetIDUniqueValidation()
Dim ws As Worksheet
Set ws = ActiveSheet
' 插入工作表变更事件，校验ID唯一性
With ws
.OnDoubleClick = ""
.CodeName = "TaskTemplate"
End With
' 注：若需强制唯一性校验，可在VBA编辑器中为工作表添加以下事件（手动补充）
' Private Sub Worksheet_Change(ByVal Target As Range)
'     If Target.Column = 1 And Target.Value <> "" Then
'         If WorksheetFunction.CountIf(Columns(1), Target.Value) > 1 Then
'             MsgBox "任务ID重复！请修改为唯一值。", vbCritical
'             Target.ClearContents
'         End If
'     End If
' End Sub
End Sub
' 子过程：文本列（非空）通用验证
Private Sub SetTextColumnValidation(col As Range, colName As String)
With col.Validation
.Delete
.Add Type:=xlValidateTextLength, _
AlertStyle:=xlValidAlertStop, _
Operator:=xlGreaterThan, _
Formula1:="0" ' 文本长度>0，禁止空值
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = colName & "验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入" & colName & "（不可为空）"
.ErrorMessage = colName & "不可为空，请输入有效文本！"
.ShowInput = True
.ShowError = True
End With
End Sub
' 子过程：清除所有验证规则（备用）
Sub ClearAllValidation()
Columns("A:H").Validation.Delete
MsgBox "所有数据验证规则已清除！", vbInformation, "操作完成"
End Sub
' ===========================================================================
' 代码结束 - 如需低版本Excel适配（无REGEXMATCH），可联系调整逻辑
' ===========================================================================
.bas文件导出与导入方法
11. 导出为.bas文件：打开Excel宏编辑器（Alt+F11）→ 右键左侧“工程”窗口→“插入”→“模块”→ 粘贴上述代码→ 右键模块名称→“导出文件”→ 保存类型选“模块文件（.bas）”，命名为“TaskTemplateValidation.bas”即可。
12. 导入.bas文件：打开模板Excel→ 启动宏编辑器→ 右键“工程”窗口→“导入文件”→ 选择保存的.bas文件→ 导入成功后，模块自动出现在工程中，直接执行“SetDataValidation”宏即可。
7.3.4 验证规则配置分步截图指引（文字版精准指引，等效截图核心节点）
以下为每一步操作的精准指引，标注关键界面、按钮位置及显示效果，无需截图也能快速上手，适配Windows系统Excel 2016/365版本。
前提准备：打开已创建好的Excel模板（含格式化表头），启用Excel宏功能（文件→选项→信任中心→信任中心设置→宏设置→勾选“启用所有宏”→ 确定，关闭Excel重新打开模板生效）。
步骤1：打开宏编辑器，导入.bas文件（2种方式可选）
13. 方式一（导入.bas文件）：
快捷键操作：打开模板Excel，按「Alt+F11」组合键，直接弹出宏编辑器窗口（左侧为“工程-VBAProject”窗口，右侧为代码编辑区）。
14. 导入文件：右键左侧“工程-VBAProject”下方的“VBAProject（你的模板文件名.xlsx）”→ 选择“导入文件”→ 找到保存的“TaskTemplateValidation.bas”文件→ 点击“打开”，左侧将新增一个模块（默认命名为“TaskTemplateValidation”）。
15. 方式二（手动粘贴代码）：
宏编辑器中，右键“工程”窗口→“插入”→“模块”，左侧新增“模块1”（可右键重命名为“数据验证”）。
16. 右侧代码编辑区清空默认内容，粘贴上述完整.bas代码→ 按「Ctrl+S」保存模块。
步骤2：执行宏代码，自动配置验证规则
17. 宏编辑器中，点击顶部菜单栏「运行」→「运行子过程/用户窗体」，或直接按「F5」键。
18. 弹出“宏”窗口，选中“SetDataValidation”（核心配置宏）→ 点击“执行”。
19. 等待1-2秒（屏幕短暂无响应为正常，代码关闭了屏幕更新），弹出“数据验证规则配置完成！”提示框→ 点击“确定”，配置完成。
20. （备用）若需清除规则，重复上述步骤，选中“ClearAllValidation”宏执行即可。
步骤3：验证规则生效测试（关键校验节点）
21. 切换回Excel模板工作表，测试各列规则：
任务ID列（A列）：输入“0”“1.5”或重复ID，弹出错误提示（对应代码中设置的提示语），无法输入。
22. 开始时间列（C列）：输入“2026-02-28”，弹出周期错误提示；输入“2026/03/01”自动转为“2026-03-01”格式。
23. 工期列（E列）：输入“2”“两周”，弹出格式错误提示；输入“2周”“3天”可正常录入。
24. 文本列（B/F/H列）：直接回车留空，弹出“不可为空”提示，强制输入内容。
25. 查看已配置规则：选中任意列→ 顶部菜单栏「数据」→ 找到“数据工具”组→ 点击“数据验证”→ 弹出窗口可查看当前列的验证规则（不可修改，需通过宏调整）。
步骤4：常见问题排查（避坑指南）
26. 宏执行报错“编译错误：未定义的函数或变量”：Excel版本过低（无REGEXMATCH函数），需升级至Excel 365，或联系调整代码正则逻辑。
27. 无法启用宏：未按前提准备启用宏，或模板保存为“.xlsx”格式（需保存为“.xlsm”格式，支持宏）。
28. 验证规则不生效：宏执行时未选中模板工作表，需确保模板工作表为当前激活工作表后，重新执行宏。
注：若需实际截图文件，可使用微信截图、Snipaste等工具，按上述步骤逐节点截图，命名为“步骤1-打开宏编辑器.png”“步骤2-执行宏.png”等，便于团队共享操作手册。
复制以下代码至Excel宏编辑器（Alt+F11），执行后可自动为模板配置所有验证规则，无需手动逐列设置：
Sub SetDataValidation()
' 任务ID列（A列）：唯一正整数
With Columns("A:A").Validation
.Delete
.Add Type:=xlValidateWholeNumber, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:="1", Formula2:="100"
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "任务ID验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入唯一正整数ID"
.ErrorMessage = "请输入唯一正整数ID，不可重复或输入非整数"
.ShowInput = True
.ShowError = True
End With
' 开始时间列（C列）：项目周期内日期
With Columns("C:C").Validation
.Delete
.Add Type:=xlValidateDate, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:="2026-03-01", Formula2:="2026-06-21"
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "开始时间验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入2026-03-01至2026-06-21之间的日期"
.ErrorMessage = "请输入项目周期内有效日期"
.ShowInput = True
.ShowError = True
End With
' 结束时间列（D列）：不早于开始时间且在周期内
With Columns("D:D").Validation
.Delete
.Add Type:=xlValidateCustom, AlertStyle:=xlValidAlertStop, Formula1:="=AND(D1>=C1,D1>=""2026-03-01"",D1<=""2026-06-21"")"
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "结束时间验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入不早于开始时间、且在项目周期内的日期"
.ErrorMessage = "结束时间需≥开始时间，且在2026-03-01至2026-06-21之间"
.ShowInput = True
.ShowError = True
End With
' 工期列（E列）：X周/X天格式
With Columns("E:E").Validation
.Delete
.Add Type:=xlValidateCustom, AlertStyle:=xlValidAlertStop, Formula1:="=OR(REGEXMATCH(E1,""^\d+周$""),REGEXMATCH(E1,""^\d+天$""))"
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "工期格式验证"
.ErrorTitle = "输入错误"
.InputMessage = "请按格式输入（例：2周、3天）"
.ErrorMessage = "格式错误，需输入X周或X天（X为正整数）"
.ShowInput = True
.ShowError = True
End With
' 前置任务列（G列）：ID/逗号/-格式
With Columns("G:G").Validation
.Delete
.Add Type:=xlValidateCustom, AlertStyle:=xlValidAlertStop, Formula1:="=OR(G1=""-"",REGEXMATCH(G1,""^(\d+,)*\d+$""))"
.IgnoreBlank = False
.InCellDropdown = True
.InputTitle = "前置任务验证"
.ErrorTitle = "输入错误"
.InputMessage = "请输入任务ID（多ID用逗号分隔）或""-"""
.ErrorMessage = "格式错误，仅允许任务ID、逗号或""-"""
.ShowInput = True
.ShowError = True
End With
End Sub
注：宏代码需在Excel中启用宏功能（文件→选项→信任中心→信任中心设置→宏设置→启用所有宏），执行后即可完成全列验证规则配置，配置后保存为“.xlsm”格式（支持宏），兼顾验证规则与可编辑性。

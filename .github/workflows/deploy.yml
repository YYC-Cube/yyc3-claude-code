name: YYC3-Claude Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Prevent concurrent deployments
concurrency:
  group: deployment
  cancel-in-progress: false

env:
  BUN_VERSION: 'latest'

jobs:
  # ============================================
  # Pre-deployment checks
  # ============================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check CI status
        id: check
        run: |
          echo "Checking if CI passed..."
          # GitHub Actions ensures CI passed before this job runs
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Verify version change
        run: |
          echo "Checking for version updates..."
          # Check if package.json version changed
          if git diff HEAD~1 HEAD --name-only | grep -q "package.json"; then
            echo "Version file changed - deploying"
          else
            echo "No version change - deploying documentation/config updates"
          fi

  # ============================================
  # Documentation deployment
  # ============================================
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: true
          allow_empty_commit: false
          commit_message: 'Deploy documentation ${{ github.sha }}'

  # ============================================
  # MCP Configuration deployment
  # ============================================
  deploy-mcp:
    name: Deploy MCP Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate MCP config
        run: |
          echo "Validating MCP configuration..."
          cat tools/mcp/mcp-config.json | jq empty > /dev/null
          echo "MCP config is valid"

      - name: Create deployment artifact
        run: |
          mkdir -p dist
          cp tools/mcp/mcp-config.json dist/
          cp tools/mcp/MCP-CONFIG-GUIDE.md dist/
          cp tools/mcp/MCP-QUICK-SETUP.md dist/
          echo "MCP configuration files packaged"

      - name: Upload MCP config artifact
        uses: actions/upload-artifact@v3
        with:
          name: mcp-config
          path: dist/
          retention-days: 30

  # ============================================
  # Release tag creation
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-docs, deploy-mcp]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release_notes
        run: |
          # Get version from package.json or use timestamp
          VERSION=$(cat package.json | jq -r '.version // "1.0.0"')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Generate release notes
          cat > release_notes.md << EOF
          ## YYC3-Claude Release $VERSION

          **Release Date**: $(date -u +"%Y-%m-%d")
          **Commit**: ${{ github.sha }}

          ### What's Included

          - Updated documentation and configuration
          - MCP server configurations
          - Skills and Subagents definitions
          - Testing framework setup
          - CI/CD pipeline configuration

          ### Installation

          \`\`\`bash
          # Clone the repository
          git clone https://github.com/YYC-Cube/YYC3-Claude.git
          cd YYC3-Claude

          # Install dependencies
          bun install

          # Run tests
          bun test
          \`\`\`

          ### Documentation

          - [README](./README.md) - Project overview
          - [Implementation Guide](./IMPLEMENTATION-GUIDE.md) - Getting started
          - [Agentic Ecosystem](./AGENTIC-ECOSYSTEM-DESIGN.md) - Architecture
          - [Intelligent Workflow](./INTELLIGENT-PROGRAMMING-WORKFLOW.md) - Development guide

          ### What's Changed

          See [commit history](https://github.com/YYC-Cube/YYC3-Claude/commits/main) for details.

          ---

          > **万象归元于云枢 | 深栈智启新纪元**
          EOF

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.release_notes.outputs.version }}
          release_name: YYC3-Claude v${{ steps.release_notes.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false

  # ============================================
  # Deployment notification
  # ============================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [release]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "======================================"
          echo "YYC3-Claude Deployment Summary"
          echo "======================================"
          echo ""
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Deployment Status:"
          echo "  Pre-deploy: ${{ needs.pre-deploy.result }}"
          echo "  Docs: ${{ needs.deploy-docs.result }}"
          echo "  MCP: ${{ needs.deploy-mcp.result }}"
          echo "  Release: ${{ needs.release.result }}"
          echo ""
          echo "======================================"
          echo "✅ Deployment Complete!"
          echo "======================================"

      - name: Create deployment badge
        run: |
          echo "Deployment badge would be updated here"
          echo "Status: deployed"
          echo "Environment: production"
